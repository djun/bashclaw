#!/usr/bin/env bash
set -euo pipefail

BASHCLAW_VERSION="1.0.0"
BASHCLAW_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASHCLAW_STATE_DIR="${BASHCLAW_STATE_DIR:-${HOME}/.bashclaw}"

export BASHCLAW_VERSION BASHCLAW_ROOT BASHCLAW_STATE_DIR

# Source library modules
for _lib in "${BASHCLAW_ROOT}"/lib/*.sh; do
  [[ -f "$_lib" ]] && source "$_lib"
done
unset _lib

usage() {
  cat <<EOF
bashclaw v${BASHCLAW_VERSION} - Bash-native AI agent framework

Usage: bashclaw <command> [options]

Commands:
  agent       Manage agents (start, stop, list, logs)
  gateway     Start/stop the HTTP gateway
  message     Send a message to an agent
  config      Manage configuration
  session     Manage conversation sessions
  onboard     Interactive setup wizard
  status      Show system status
  doctor      Run diagnostics
  version     Show version info

Options:
  -h, --help      Show this help
  -v, --version   Show version

Environment:
  BASHCLAW_STATE_DIR   State directory (default: ~/.bashclaw)
  BASHCLAW_CONFIG      Config file path override
  LOG_LEVEL            Log level: debug|info|warn|error|fatal|silent
  MODEL_ID             Default model ID

EOF
}

cmd_version() {
  printf 'bashclaw %s\n' "$BASHCLAW_VERSION"
}

cmd_status() {
  printf '=== bashclaw status ===\n'
  printf 'Version:    %s\n' "$BASHCLAW_VERSION"
  printf 'State dir:  %s\n' "$BASHCLAW_STATE_DIR"
  printf 'Config:     %s\n' "$(config_path)"

  if [[ -f "$(config_path)" ]]; then
    printf 'Config:     found\n'
  else
    printf 'Config:     not found\n'
  fi

  local gw_port
  gw_port="$(config_get '.gateway.port' '18789')"
  if ! is_port_available "$gw_port"; then
    printf 'Gateway:    running (port %s)\n' "$gw_port"
  else
    printf 'Gateway:    stopped\n'
  fi

  local session_count=0
  local session_dir="${BASHCLAW_STATE_DIR}/sessions"
  if [[ -d "$session_dir" ]]; then
    session_count="$(find "$session_dir" -name '*.jsonl' 2>/dev/null | wc -l | tr -d ' ')"
  fi
  printf 'Sessions:   %s\n' "$session_count"
}

cmd_doctor() {
  local issues=0
  printf '=== bashclaw doctor ===\n\n'

  # Check required commands
  local cmds=(bash jq curl)
  for cmd in "${cmds[@]}"; do
    if is_command_available "$cmd"; then
      printf '[OK]   %s found: %s\n' "$cmd" "$(command -v "$cmd")"
    else
      printf '[FAIL] %s not found\n' "$cmd"
      issues=$((issues + 1))
    fi
  done

  # Check optional commands
  local opt_cmds=(python3 uuidgen socat nc)
  for cmd in "${opt_cmds[@]}"; do
    if is_command_available "$cmd"; then
      printf '[OK]   %s found (optional)\n' "$cmd"
    else
      printf '[WARN] %s not found (optional)\n' "$cmd"
    fi
  done

  printf '\n'

  # Check state directory
  if [[ -d "$BASHCLAW_STATE_DIR" ]]; then
    printf '[OK]   State dir exists: %s\n' "$BASHCLAW_STATE_DIR"
  else
    printf '[WARN] State dir missing: %s\n' "$BASHCLAW_STATE_DIR"
  fi

  # Check config
  local cfg_path
  cfg_path="$(config_path)"
  if [[ -f "$cfg_path" ]]; then
    printf '[OK]   Config found: %s\n' "$cfg_path"
    if config_validate; then
      printf '[OK]   Config is valid JSON\n'
    else
      printf '[FAIL] Config validation failed\n'
      issues=$((issues + 1))
    fi
  else
    printf '[WARN] No config file (run: bashclaw config init)\n'
  fi

  # Check API key
  if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
    printf '[OK]   ANTHROPIC_API_KEY is set\n'
  else
    printf '[WARN] ANTHROPIC_API_KEY not set\n'
  fi

  printf '\n'
  if (( issues > 0 )); then
    printf 'Found %d issue(s)\n' "$issues"
    return 1
  else
    printf 'All checks passed\n'
    return 0
  fi
}

# Route to sub-commands
main() {
  local cmd="${1:-}"
  shift || true

  case "$cmd" in
    agent)
      cmd_agent "$@"
      ;;
    gateway)
      cmd_gateway "$@"
      ;;
    message|msg)
      cmd_message "$@"
      ;;
    config|cfg)
      cmd_config "$@"
      ;;
    session|sess)
      cmd_session "$@"
      ;;
    onboard|setup)
      cmd_onboard "$@"
      ;;
    status)
      cmd_status
      ;;
    doctor)
      cmd_doctor
      ;;
    version|-v|--version)
      cmd_version
      ;;
    help|-h|--help|"")
      usage
      ;;
    *)
      log_error "Unknown command: $cmd"
      usage
      exit 1
      ;;
  esac
}

main "$@"
